<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Add TV Show</title>
    <style>
        body { font-family: sans-serif; padding: 20px; max-width: 800px; margin: auto; }
        h1 { text-align: center; }
        form div { margin-bottom: 15px; }
        label { display: block; font-weight: bold; margin-bottom: 5px; }
        input[type="text"], input[type="number"], input[type="date"], textarea { width: 100%; padding: 8px; box-sizing: border-box; }
        textarea { height: 150px; }
        .button-group { display: flex; gap: 10px; }
        button { padding: 10px 15px; cursor: pointer; }
    </style>
</head>
<body>
    <h1>Add TV Show</h1>
    <form id="add-tv-form">
        <div>
            <label for="tmdb_id">TMDB ID:</label>
            <input type="number" id="tmdb_id" name="tmdb_id" required>
            <button type="button" onclick="fetchTmdbData('tv')">Fetch from TMDB</button>
        </div>
        <div>
            <label for="title">Title:</label>
            <input type="text" id="title" name="title" required>
        </div>
        <div>
            <label for="description">Description:</label>
            <textarea id="description" name="description"></textarea>
        </div>
        <div>
            <label for="thumbnail">Thumbnail URL:</label>
            <input type="text" id="thumbnail" name="thumbnail">
        </div>
        <div>
            <label for="release_date">Release Date:</label>
            <input type="date" id="release_date" name="release_date">
        </div>
        <div>
            <label for="language">Language:</label>
            <input type="text" id="language" name="language">
        </div>
        <div>
            <label for="rating">Rating:</label>
            <input type="number" step="0.1" id="rating" name="rating">
        </div>
        <div>
            <label for="cast">Cast (JSON):</label>
            <textarea id="cast" name="cast"></textarea>
        </div>
        <div>
            <label for="total_seasons">Total Seasons:</label>
            <input type="number" id="total_seasons" name="total_seasons">
        </div>
        <div class="button-group">
            <button type="submit">Save TV Show</button>
            <a href="/admin">Cancel</a>
        </div>
    </form>
    <script>
        const TMDB_API_KEY = "52f6a75a38a397d940959b336801e1c3";

        async function fetchTmdbData(mediaType) {
            const tmdbId = document.getElementById('tmdb_id').value;
            if (!tmdbId) {
                alert('Please enter a TMDB ID.');
                return;
            }

            try {
                const response = await fetch('/admin/tmdb_fetch', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Basic ' + btoa('venura:venura')
                    },
                    body: JSON.stringify({ tmdb_id: tmdbId, media_type: mediaType })
                });

                if (response.ok) {
                    const data = await response.json();
                    document.getElementById('title').value = data.title || '';
                    document.getElementById('description').value = data.description || '';
                    document.getElementById('thumbnail').value = data.thumbnail || '';
                    document.getElementById('release_date').value = data.release_date || '';
                    document.getElementById('language').value = data.language || '';
                    document.getElementById('rating').value = data.rating || '';
                    document.getElementById('cast').value = JSON.stringify(data.cast, null, 2) || '[]';
                    document.getElementById('total_seasons').value = data.total_seasons || '';
                } else {
                    const errorData = await response.json();
                    alert('Error fetching from TMDB: ' + (errorData.message || response.statusText));
                }
            } catch (error) {
                alert('An error occurred: ' + error.message);
            }
        }

        document.getElementById('add-tv-form').addEventListener('submit', async function(event) {
            event.preventDefault();
            const form = event.target;
            const formData = new FormData(form);
            const data = {
                type: 'tv',
                title: formData.get('title'),
                description: formData.get('description'),
                thumbnail: formData.get('thumbnail'),
                release_date: formData.get('release_date'),
                language: formData.get('language'),
                rating: parseFloat(formData.get('rating')),
                cast: JSON.parse(formData.get('cast') || '[]'),
                total_seasons: parseInt(formData.get('total_seasons')),
                seasons: {}
            };

            try {
                const response = await fetch('/admin/media', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Basic ' + btoa('venura:venura')
                    },
                    body: JSON.stringify(data)
                });
                const result = await response.json();
                if (response.ok) {
                    alert('TV show saved successfully!');
                    window.location.href = '/admin/search';
                } else {
                    alert('Error: ' + result.message);
                }
            } catch (error) {
                alert('An unexpected error occurred.');
            }
        });
    </script>
</body>
</html>
